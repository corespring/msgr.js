!function(a){function b(a,b,c){if(!b.postMessage)throw a+" - source doesn't have postMessage";if(!c.postMessage)throw a+" - source doesn't have postMessage"}function c(a,b){try{return JSON.parse(a)}catch(c){return b&&b.warn("error parsing event data"),{}}}function d(a,b){return Array.prototype.slice.call(a,b||0)}function e(a,b){var c=function(c){var e=function(){if(b&&b.logger&&b.logger[c])b.logger[c].bind(null,a).apply(null,arguments);else if(window.console&&window.console[c]){var e=d(arguments);e.unshift(a);var f=window.console[c];f.apply?f.apply(window.console,e):alert(e.join(", "))}};return b&&(b.enableLogging||b.logger)?e:function(){}};this.debug=c("debug"),this.log=c("log"),this.warn=c("warn"),this.info=c("info")}function f(a){var b=null;this.add=function(c){b&&this.remove(),a[e()](d(),c),b=c},this.remove=function(){a[c()](d(),b,!1)};var c=function(){return a.removeEventListener?"removeEventListener":"detachEvent"},d=function(){return a.addEventListener?"message":"onmessage"},e=function(){return a.addEventListener?"addEventListener":"attachEvent"}}function g(a,g,h){var i=function(){return(new Date).getTime()+"-"+Math.floor(1e3*Math.random())};b("msgr.Dispatcher",a,g);var j=new e(i()+" - msgr.Dispatcher",h),k=new f(a),l=[];j.debug("new instance");var m=!1;j.debug("receiver ready: ",m),j.debug("source: ",a),j.debug("target: ",g);var n=function(){for(var a=0;a<l.length;a++){var b=l[a];this.send(b.messageType,b.data,b.callback)}l=[]},o={},p=function(a){if(j.log("handlePostMessage",a.data),a.source!==g)return void j.warn("not the source - ignore");var b=c(a.data,j);"receiver-ready"===b.mode&&(m?j.debug("receiver ready already"):(j.debug("receiver is ready - flush the queue..."),m=!0,g.postMessage(JSON.stringify({mode:"sender-ready"}),"*"),n.bind(this)())),o[b.uid]?(o[b.uid](b.err,b.result),o[b.uid]=null):j.warn("no callback set for: ",b.uid)};k.add(p.bind(this)),this.send=function(){var a,b,c=d(arguments,0),e=c[0];if("function"==typeof c[1]?(a=null,b=c[1]):(a=c[1],b=c[2]),m){var f=i();if(j.log("send:",e,f),o[f])throw"uid already exists: "+f;o[f]=b;var h={messageType:e,mode:"request",uid:f};a&&(h.data=a),g.postMessage(JSON.stringify(h),"*")}else j.debug("receiver not ready yet, add to pendingMessages"),l.push({messageType:e,data:a,callback:b})},this.remove=function(){k.remove()},this.send("sender-ready")}function h(a,g,h){var i=new e("msgr.Receiver",h),j=new f(a);if(b("msgr.Receiver",a,g),i.debug("new instance"),a===g)return i.warn("the source and target are the same - nothing to listen to"),void(this.on=function(){throw"source === target - using a no-op function"});var k={},l=!1,m=function(a){function b(a,b){var c=(d(arguments,0),{messageType:e.messageType,uid:e.uid,mode:"response",err:a,result:b}),f=g;i.log("Receiver - return result: ",JSON.stringify(c)),f.postMessage(JSON.stringify(c),"*")}i.log("handlePostMessage: ",JSON.stringify(a.data));var e=c(a.data,i);if(i.log("data:",e),"sender-ready"===e.mode&&(l?i.debug("sender ready already"):(i.debug("sender is ready."),l=!0)),i.log("data message type: ",e.messageType),e.messageType)if(k.allMessageTypes&&!k[e.messageType])i.log("using the * handler for",e.messageType),k.allMessageTypes(e.messageType,e.data,b);else if(k[e.messageType])for(var f=0;f<k[e.messageType].length;f++)i.log("call the handler for",e.messageType),k[e.messageType][f](e.data,b)};i.log("add [handlePostMessage] to ",a.location.pathname),j.add(m.bind(this)),this.on=function(a,b){"*"===a?k.allMessageTypes=b:(k[a]=k[a]||[],k[a].push(b),i.log(".on - add handler for",a,"no of handlers:",k[a].length))},this.remove=function(){j.remove()},function(){function a(){i.log("sendReceiverReady",l),l||(i.log("posting receiver-ready"),g.postMessage(JSON.stringify({mode:"receiver-ready"}),"*"),setTimeout(a,300))}a()}()}function i(a,b,c){var e=new g(a,b,c),f=new h(a,b,c);this.send=function(){e.send.apply(e,d(arguments,0))},this.on=function(){f.on.apply(f,d(arguments,0))},this.remove=function(){e.remove(),f.remove()}}if(!JSON)throw"JSON is undefined, if you are using ie8 be sure to define a doctype eg: <!DOCTYPE html>";Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=d(arguments,1),c=this,e=function(){},f=function(){return c.apply(this instanceof e&&a?this:a,b.concat(d(arguments)))};return e.prototype=this.prototype,f.prototype=new e,f}),a.msgr=a.msgr||{},a.msgr.Receiver=h,a.msgr.Dispatcher=g,a.msgr.Channel=i}(this);