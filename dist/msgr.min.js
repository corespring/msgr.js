!function(a){function b(a,b){var c=function(c){return function(){if(b&&b[c])b[c].bind(null,a).apply(null,arguments);else if(window.console&&window.console[c]){var d=Array.prototype.slice.call(arguments);d.unshift(a);var e=window.console[c];e.apply?e.apply(window.console,d):alert(d.join(", "))}}};this.debug=c("debug"),this.log=c("log"),this.warn=c("warn"),this.info=c("info")}function c(a){this.addMessageListener=function(d){a[c()](b(),d)};var b=function(){return a.addEventListener?"message":"onmessage"},c=function(){return a.addEventListener?"addEventListener":"attachEvent"}}function d(a,d,e){var f=new b("msgr.Dispatcher",e),g=new c(a),h=[];f.debug("new instance");var i=!1,j=function(){return(new Date).getTime()+"-"+Math.floor(1e3*Math.random())};f.debug("source: ",a),f.debug("target: ",d);var k=function(){for(var a=0;a<h.length;a++){var b=h[a];this.send(b.messageType,b.data,b.callback)}h=[]},l={},m=function(a){if(alert("ie: handle-post-messaage",a.source),f.log("handlePostMessage",a.data),a.source!==d.contentWindow)return void f.warn("not the source - ignore");var b;try{b=JSON.parse(a.data)}catch(c){f.warn("error parsing event data"),b={}}"receiver-ready"==b.mode&&(f.debug("receiver is ready - flush the queue..."),i=!0,k.bind(this)()),l[b.uid]&&(l[b.uid](b.err,b.result),l[b.uid]=null)};g.addMessageListener(m.bind(this)),this.send=function(a,b,c){if(i){var e=j();if(f.log("send:",a,e),l[e])throw"uid already exists: "+e;l[e]=c;var g={messageType:a,mode:"request",uid:e,data:name};d.contentWindow.postMessage(JSON.stringify(g),"*")}else h.push({messageType:a,data:b,callback:c})}}function e(a,d,e){var f=new b("msgr.Receiver",e),g=new c(a);if(f.debug("new instance"),a===d)return void f.warn("the source and target are the same - nothing to listen to");alert("send receiver-ready"),setTimeout(function(){d.postMessage(JSON.stringify({mode:"receiver-ready"}),"*")},200);var h={},i=function(a){f.log("handlePostMessage: ",JSON.stringify(a.data));var b;try{b=JSON.parse(a.data)}catch(c){b={}}b.messageType&&h[b.messageType]&&(f.log("call the handler for",b.messageType),h[b.messageType](b.data,function(){var a=Array.prototype.slice.call(arguments,0),c={uid:b.uid,mode:"response",err:a[0],result:a[1]},e=d;f.log("Receiver - return result: ",JSON.stringify(c)),e.postMessage(JSON.stringify(c),"*")}))};f.log("add [handlePostMessage] to ",a.location.pathname),g.addMessageListener(i),this.on=function(a,b){f.log(".on - add handler for",a),h[a]&&(h[a]=null),h[a]=b}}if(!JSON)throw"JSON is undefined, if you are using ie8 be sure to define a doctype eg: <!DOCTYPE html>";Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),a.msgr=a.msgr||{},a.msgr.Receiver=e,a.msgr.Dispatcher=d}(this);