!function(a){function b(){var a=(new Date).getTime(),b=function(b){var c=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"==b?c:3&c|8).toString(16)},c="xxxxxxxxxxxx".replace(/[xy]/g,b);return c}function c(a,b,c){if(!b.postMessage)throw a+" - source doesn't have postMessage";if(!c.postMessage)throw a+" - source doesn't have postMessage"}function d(a,b){try{return JSON.parse(a)}catch(c){return b&&b.warn("error parsing event data"),{}}}function e(a,b){return Array.prototype.slice.call(a,b||0)}function f(a,b){var c=function(c){var d=function(){if(b&&b.logger&&b.logger[c])b.logger[c].bind(null,a).apply(null,arguments);else if(window.console&&window.console[c]){var d=e(arguments);d.unshift(a);var f=window.console[c];f.apply?f.apply(window.console,d):alert(d.join(", "))}};return b&&(b.enableLogging||b.logger)?d:function(){}};this.debug=c("debug"),this.log=c("log"),this.warn=c("warn"),this.info=c("info")}function g(a){var b=null;this.add=function(c){b&&this.remove(),a[e()](d(),c),b=c},this.remove=function(){a[c()](d(),b,!1)};var c=function(){return a.removeEventListener?"removeEventListener":"detachEvent"},d=function(){return a.addEventListener?"message":"onmessage"},e=function(){return a.addEventListener?"addEventListener":"attachEvent"}}function h(a,h,i,j,k){c("msgr.Dispatcher",a,h);var l=new f(b()+" - msgr.Dispatcher",i),m=new g(a),n=[];l.debug("new instance");var o=!1;l.debug("receiver ready: ",o),l.debug("source: ",a),l.debug("target: ",h);var p=function(){for(var a=0;a<n.length;a++){var b=n[a];this.send(b.messageType,b.data,b.callback)}n=[]},q={},r=null,s=function(a){if(l.log("handlePostMessage",a.data),a.source!==h)return void l.warn("not the source - ignore");var b=d(a.data,l);if("receiver-ready"===b.mode)o?l.debug("receiver ready already"):(l.debug("receiver is ready - flush the queue..."),o=!0,r=b.receiver,h.postMessage(JSON.stringify({mode:"dispatcher-ready"}),"*"),p.bind(this)());else if("dispatcher-ready"===b.mode)console.log("dispatcher-ready");else{if(b&&r&&(b.source!==r.source||b.target!==r.target))return void console.log("-----> skip!!",b,r);q[b.uid]?(q[b.uid](b.err,b.result),q[b.uid]=null):l.warn("no callback set for: ",b.uid)}};m.add(s.bind(this)),this.send=function(){var a,c,d=e(arguments,0),f=d[0];if("function"==typeof d[1]?(a=null,c=d[1]):(a=d[1],c=d[2]),o){var g=b();if(l.log("send:",f,g),q[g])throw"uid already exists: "+g;q[g]=c;var i={messageType:f,mode:"request",uid:g,source:j,target:k};a&&(i.data=a),h.postMessage(JSON.stringify(i),"*")}else l.debug("receiver not ready yet, add to pendingMessages"),n.push({messageType:f,data:a,callback:c})},this.remove=function(){m.remove()}}function i(a,b,h,i,j){var k=new f("msgr.Receiver [src: "+i+", tar: "+j+"]",h),l=new g(a);if(c("msgr.Receiver",a,b),k.debug("new instance"),a===b)return k.warn("the source and target are the same - nothing to listen to"),void(this.on=function(){throw"source === target - using a no-op function"});var m={},n=!1,o=function(a){function c(a,c){var d=(e(arguments,0),{messageType:f.messageType,uid:f.uid,mode:"response",err:a,result:c}),g=b;k.log("Receiver - return result: ",JSON.stringify(d)),g.postMessage(JSON.stringify(d),"*")}k.log("handlePostMessage: ",JSON.stringify(a.data));var f=d(a.data,k);if(k.log("data:",f),"dispatcher-ready"===f.mode&&(n?k.debug("dispatcher ready already"):(k.debug("dispatcher is ready now."),n=!0)),k.log("data message type: ",f.messageType),console.log("----->",i,j,f),f.messageType)if(m.allMessageTypes&&!m[f.messageType])k.log("using the * handler for",f.messageType),m.allMessageTypes(f.messageType,f.data,c);else if(m[f.messageType]&&f.source===i&&f.target===j)for(var g=0;g<m[f.messageType].length;g++)k.log("call the handler for",f.messageType),m[f.messageType][g](f.data,c)};k.log("add [handlePostMessage] to ",a.location.pathname),l.add(o.bind(this)),this.on=function(a,b){"*"===a?m.allMessageTypes=b:(m[a]=m[a]||[],m[a].push(b),k.log(".on - add handler for",a,"no of handlers:",m[a].length))},this.remove=function(){l.remove()},function(){function a(){k.log("sendReceiverReady",n),n||(k.log("sending receiver-ready"),b.postMessage(JSON.stringify({mode:"receiver-ready",receiver:{source:i,target:j}}),"*"),setTimeout(a,300))}a()}()}function j(a,c,d){var f="source-"+b(),g="target-"+b(),j=new h(a,c,d,f,g),k=new i(a,c,d,f,g);this.send=function(){j.send.apply(j,e(arguments,0))},this.on=function(){k.on.apply(k,e(arguments,0))},this.remove=function(){j.remove(),k.remove()}}if(!JSON)throw"JSON is undefined, if you are using ie8 be sure to define a doctype eg: <!DOCTYPE html>";Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=e(arguments,1),c=this,d=function(){},f=function(){return c.apply(this instanceof d&&a?this:a,b.concat(e(arguments)))};return d.prototype=this.prototype,f.prototype=new d,f}),a.msgr=a.msgr||{},a.msgr.Receiver=i,a.msgr.Dispatcher=h,a.msgr.Channel=j}(this);