!function(a){function b(a,b){var c=function(c){var d=function(){if(b&&b.logger&&b.logger[c])b.logger[c].bind(null,a).apply(null,arguments);else if(window.console&&window.console[c]){var d=Array.prototype.slice.call(arguments);d.unshift(a);var e=window.console[c];e.apply?e.apply(window.console,d):alert(d.join(", "))}};return b&&(b.enableLogging||b.logger)?d:function(){}};this.debug=c("debug"),this.log=c("log"),this.warn=c("warn"),this.info=c("info")}function c(a){var b=null;this.add=function(c){b&&this.remove(),a[e()](d(),c),b=c},this.remove=function(){a[c()](d(),b,!1)};var c=function(){return a.removeEventListener?"removeEventListener":"detachEvent"},d=function(){return a.addEventListener?"message":"onmessage"},e=function(){return a.addEventListener?"addEventListener":"attachEvent"}}function d(a,d,e){var f=function(){return(new Date).getTime()+"-"+Math.floor(1e3*Math.random())},g=new b(f()+" - msgr.Dispatcher",e),h=new c(a),i=[];g.debug("new instance");var j=!1;g.debug("source: ",a),g.debug("target: ",d);var k=function(){for(var a=0;a<i.length;a++){var b=i[a];this.send(b.messageType,b.data,b.callback)}i=[]},l={},m=function(a){if(g.log("handlePostMessage",a.data),a.source!==d.contentWindow)return void g.warn("not the source - ignore");var b;try{b=JSON.parse(a.data)}catch(c){g.warn("error parsing event data"),b={}}"receiver-ready"==b.mode&&(g.debug("receiver is ready - flush the queue..."),j=!0,k.bind(this)()),l[b.uid]&&(l[b.uid](b.err,b.result),l[b.uid]=null)};h.add(m.bind(this)),this.send=function(a,b,c){if(j){var e=f();if(g.log("send:",a,e),l[e])throw"uid already exists: "+e;l[e]=c;var h={messageType:a,mode:"request",uid:e,data:name};d.contentWindow.postMessage(JSON.stringify(h),"*")}else i.push({messageType:a,data:b,callback:c})},this.remove=function(){h.remove()}}function e(a,d,e){var f=new b("msgr.Receiver",e),g=new c(a);if(f.debug("new instance"),a===d)return void f.warn("the source and target are the same - nothing to listen to");var h=function(){return window.addEventListener?!1:!0};h()?setTimeout(function(){d.postMessage(JSON.stringify({mode:"receiver-ready"}),"*")},200):d.postMessage(JSON.stringify({mode:"receiver-ready"}),"*");var i={},j=function(a){f.log("handlePostMessage: ",JSON.stringify(a.data));var b;try{b=JSON.parse(a.data)}catch(c){b={}}b.messageType&&i[b.messageType]&&(f.log("call the handler for",b.messageType),i[b.messageType](b.data,function(){var a=Array.prototype.slice.call(arguments,0),c={uid:b.uid,mode:"response",err:a[0],result:a[1]},e=d;f.log("Receiver - return result: ",JSON.stringify(c)),e.postMessage(JSON.stringify(c),"*")}))};f.log("add [handlePostMessage] to ",a.location.pathname),g.add(j),this.on=function(a,b){f.log(".on - add handler for",a),i[a]&&(i[a]=null),i[a]=b}}if(!JSON)throw"JSON is undefined, if you are using ie8 be sure to define a doctype eg: <!DOCTYPE html>";Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),a.msgr=a.msgr||{},a.msgr.Receiver=e,a.msgr.Dispatcher=d}(this);