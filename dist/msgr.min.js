!function(a){function b(a,b,c){if(!b.postMessage)throw a+" - source doesn't have postMessage";if(!c.postMessage)throw a+" - source doesn't have postMessage"}function c(a,b){var c=function(c){var d=function(){if(b&&b.logger&&b.logger[c])b.logger[c].bind(null,a).apply(null,arguments);else if(window.console&&window.console[c]){var d=Array.prototype.slice.call(arguments);d.unshift(a);var e=window.console[c];e.apply?e.apply(window.console,d):alert(d.join(", "))}};return b&&(b.enableLogging||b.logger)?d:function(){}};this.debug=c("debug"),this.log=c("log"),this.warn=c("warn"),this.info=c("info")}function d(a){var b=null;this.add=function(c){b&&this.remove(),a[e()](d(),c),b=c},this.remove=function(){a[c()](d(),b,!1)};var c=function(){return a.removeEventListener?"removeEventListener":"detachEvent"},d=function(){return a.addEventListener?"message":"onmessage"},e=function(){return a.addEventListener?"addEventListener":"attachEvent"}}function e(a,e,f){var g=function(){return(new Date).getTime()+"-"+Math.floor(1e3*Math.random())};b("msgr.Dispatcher",a,e);var h=new c(g()+" - msgr.Dispatcher",f),i=new d(a),j=[];h.debug("new instance");var k=!1;h.debug("source: ",a),h.debug("target: ",e);var l=function(){for(var a=0;a<j.length;a++){var b=j[a];this.send(b.messageType,b.data,b.callback)}j=[]},m={},n=function(a){if(h.log("handlePostMessage",a.data),a.source!==e)return void h.warn("not the source - ignore");var b;try{b=JSON.parse(a.data)}catch(c){h.warn("error parsing event data"),b={}}"receiver-ready"==b.mode&&(h.debug("receiver is ready - flush the queue..."),k=!0,l.bind(this)()),m[b.uid]&&(m[b.uid](b.err,b.result),m[b.uid]=null)};i.add(n.bind(this)),this.send=function(){var a,b,c=Array.prototype.slice.call(arguments,0),d=c[0];if("function"==typeof c[1]?(a=null,b=c[1]):(a=c[1],b=c[2]),k){var f=g();if(h.log("send:",d,f),m[f])throw"uid already exists: "+f;m[f]=b;var i={messageType:d,mode:"request",uid:f};a&&(i.data=a),e.postMessage(JSON.stringify(i),"*")}else j.push({messageType:d,data:a,callback:b})},this.remove=function(){i.remove()}}function f(a,e,f){var g=new c("msgr.Receiver",f),h=new d(a);if(b("msgr.Receiver",a,e),g.debug("new instance"),a===e)return void g.warn("the source and target are the same - nothing to listen to");var i=function(){return window.addEventListener?!1:!0};i()?setTimeout(function(){e.postMessage(JSON.stringify({mode:"receiver-ready"}),"*")},200):e.postMessage(JSON.stringify({mode:"receiver-ready"}),"*");var j={},k=function(a){g.log("handlePostMessage: ",JSON.stringify(a.data));var b;try{b=JSON.parse(a.data)}catch(c){b={}}b.messageType&&j[b.messageType]&&(g.log("call the handler for",b.messageType),j[b.messageType](b.data,function(){var a=Array.prototype.slice.call(arguments,0),c={uid:b.uid,mode:"response",err:a[0],result:a[1]},d=e;g.log("Receiver - return result: ",JSON.stringify(c)),d.postMessage(JSON.stringify(c),"*")}))};g.log("add [handlePostMessage] to ",a.location.pathname),h.add(k),this.on=function(a,b){g.log(".on - add handler for",a),j[a]&&(j[a]=null),j[a]=b}}if(!JSON)throw"JSON is undefined, if you are using ie8 be sure to define a doctype eg: <!DOCTYPE html>";Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),a.msgr=a.msgr||{},a.msgr.Receiver=f,a.msgr.Dispatcher=e}(this);