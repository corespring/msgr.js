!function(a){function b(a,b,c){if(!b.postMessage)throw a+" - source doesn't have postMessage";if(!c.postMessage)throw a+" - source doesn't have postMessage"}function c(a,b){var c=function(c){var d=function(){if(b&&b.logger&&b.logger[c])b.logger[c].bind(null,a).apply(null,arguments);else if(window.console&&window.console[c]){var d=Array.prototype.slice.call(arguments);d.unshift(a);var e=window.console[c];e.apply?e.apply(window.console,d):alert(d.join(", "))}};return b&&(b.enableLogging||b.logger)?d:function(){}};this.debug=c("debug"),this.log=c("log"),this.warn=c("warn"),this.info=c("info")}function d(a){var b=null;this.add=function(c){b&&this.remove(),a[e()](d(),c),b=c},this.remove=function(){a[c()](d(),b,!1)};var c=function(){return a.removeEventListener?"removeEventListener":"detachEvent"},d=function(){return a.addEventListener?"message":"onmessage"},e=function(){return a.addEventListener?"addEventListener":"attachEvent"}}function e(a,e,f){var g=function(){return(new Date).getTime()+"-"+Math.floor(1e3*Math.random())},h=function(){return window.addEventListener?!1:!0};b("msgr.Dispatcher",a,e);var i=new c(g()+" - msgr.Dispatcher",f),j=new d(a),k=[];i.debug("new instance");var l=!h()&&window.top===e||!1;i.debug("receiver ready: ",l),i.debug("source: ",a),i.debug("target: ",e);var m=function(){for(var a=0;a<k.length;a++){var b=k[a];this.send(b.messageType,b.data,b.callback)}k=[]},n={},o=function(a){if(i.log("handlePostMessage",a.data),a.source!==e)return void i.warn("not the source - ignore");var b;try{b=JSON.parse(a.data)}catch(c){i.warn("error parsing event data"),b={}}"receiver-ready"==b.mode&&(i.debug("receiver is ready - flush the queue..."),l=!0,m.bind(this)()),n[b.uid]?(n[b.uid](b.err,b.result),n[b.uid]=null):i.warn("no callback set for: ",b.uid)};j.add(o.bind(this)),this.send=function(){var a,b,c=Array.prototype.slice.call(arguments,0),d=c[0];if("function"==typeof c[1]?(a=null,b=c[1]):(a=c[1],b=c[2]),l){var f=g();if(i.log("send:",d,f),n[f])throw"uid already exists: "+f;n[f]=b;var h={messageType:d,mode:"request",uid:f};a&&(h.data=a),e.postMessage(JSON.stringify(h),"*")}else i.debug("receiver not ready yet, add to pendingMessages"),k.push({messageType:d,data:a,callback:b})},this.remove=function(){j.remove()}}function f(a,e,f){var g=new c("msgr.Receiver",f),h=new d(a);if(b("msgr.Receiver",a,e),g.debug("new instance"),a===e)return g.warn("the source and target are the same - nothing to listen to"),void(this.on=function(){throw"source === target - using a no-op function"});var i=function(){return window.addEventListener?!1:!0};i()?setTimeout(function(){e.postMessage(JSON.stringify({mode:"receiver-ready"}),"*")},200):e.postMessage(JSON.stringify({mode:"receiver-ready"}),"*");var j={},k=function(a){function b(a,b){var d=(Array.prototype.slice.call(arguments,0),{uid:c.uid,mode:"response",err:a,result:b}),f=e;g.log("Receiver - return result: ",JSON.stringify(d)),f.postMessage(JSON.stringify(d),"*")}g.log("handlePostMessage: ",JSON.stringify(a.data));var c;try{c=JSON.parse(a.data)}catch(d){c={}}g.log("data:",c),g.log("data message type: ",c.messageType),c.messageType&&(j.allMessageTypes&&!j[c.messageType]?(g.log("using the * handler for",c.messageType),j.allMessageTypes(c.messageType,c.data,b)):j[c.messageType]&&(g.log("call the handler for",c.messageType),j[c.messageType](c.data,b)))};g.log("add [handlePostMessage] to ",a.location.pathname),h.add(k),this.on=function(a,b){"*"===a?j.allMessageTypes=b:(g.log(".on - add handler for",a),j[a]&&(j[a]=null),j[a]=b)}}function g(a,b,c){var d=new e(a,b,c),g=new f(a,b,c);this.send=function(){d.send.apply(d,Array.prototype.slice.call(arguments,0))},this.on=function(){g.on.apply(g,Array.prototype.slice.call(arguments,0))},this.remove=function(){d.remove()}}if(!JSON)throw"JSON is undefined, if you are using ie8 be sure to define a doctype eg: <!DOCTYPE html>";Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),a.msgr=a.msgr||{},a.msgr.Receiver=f,a.msgr.Dispatcher=e,a.msgr.Channel=g}(this);