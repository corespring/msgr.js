!function(a){function b(){var a=(new Date).getTime(),b=function(b){var c=(a+16*Math.random())%16|0;return a=Math.floor(a/16),("x"==b?c:3&c|8).toString(16)},c="xxxxxxxxxxxx".replace(/[xy]/g,b);return c}function c(a,b,c){if(!b.postMessage)throw a+" - source doesn't have postMessage";if(!c.postMessage)throw a+" - source doesn't have postMessage"}function d(a,b){try{return JSON.parse(a)}catch(a){return b&&b.warn("error parsing event data"),{}}}function e(a,b){return Array.prototype.slice.call(a,b||0)}function f(a,b){var c=function(c){var d=function(){if(b&&b.logger&&b.logger[c])b.logger[c].bind(null,a).apply(null,arguments);else if(window.console&&window.console[c]){var d=e(arguments);d.unshift(a);var f=window.console[c];f.apply?f.apply(window.console,d):alert(d.join(", "))}};return b&&(b.enableLogging||b.logger)?d:function(){}};this.debug=c("debug"),this.log=c("log"),this.warn=c("warn"),this.info=c("info")}function g(a){var b=null;this.add=function(c){b&&this.remove(),a[e()](d(),c),b=c},this.remove=function(){a[c()](d(),b,!1)};var c=function(){return a.removeEventListener?"removeEventListener":"detachEvent"},d=function(){return a.addEventListener?"message":"onmessage"},e=function(){return a.addEventListener?"addEventListener":"attachEvent"}}function h(a,h,i){c("msgr.Dispatcher",a,h);var j=new f(b()+" - msgr.Dispatcher",i),k=new g(a),l=[];j.debug("new instance");var m=!1;j.debug("receiver ready: ",m),j.debug("source: ",a),j.debug("target: ",h);var n=function(){for(var a=0;a<l.length;a++){var b=l[a];this.send(b.messageType,b.data,b.callback)}l=[]},o={},p=function(a){if(j.log("handlePostMessage",a.data),a.source!==h)return void j.warn("not the source - ignore");var b=d(a.data,j);"receiver-ready"===b.mode&&(m?j.debug("receiver ready already"):(j.debug("receiver is ready - flush the queue..."),m=!0,h.postMessage(JSON.stringify({mode:"dispatcher-ready"}),"*"),n.bind(this)())),o[b.uid]?(o[b.uid](b.err,b.result),o[b.uid]=null):j.warn("no callback set for: ",b.uid)};k.add(p.bind(this)),this.send=function(){var a,c,d=e(arguments,0),f=d[0];if("function"==typeof d[1]?(a=null,c=d[1]):(a=d[1],c=d[2]),m){var g=b();if(j.log("send:",f,g),o[g])throw"uid already exists: "+g;o[g]=c;var i={messageType:f,mode:"request",uid:g};a&&(i.data=a),h.postMessage(JSON.stringify(i),"*")}else j.debug("receiver not ready yet, add to pendingMessages"),l.push({messageType:f,data:a,callback:c})},this.remove=function(){k.remove()}}function i(a,b,e){var h=new f("msgr.Receiver",e),i=new g(a);if(c("msgr.Receiver",a,b),h.debug("new instance"),a===b)return h.warn("the source and target are the same - nothing to listen to"),void(this.on=function(){throw"source === target - using a no-op function"});var j={},k=!1,l=function(a){function c(a,c){var d={messageType:e.messageType,uid:e.uid,mode:"response",err:a,result:c},f=b;h.log("Receiver - return result: ",JSON.stringify(d)),f.postMessage(JSON.stringify(d),"*")}if(h.log("handlePostMessage: ",JSON.stringify(a.data)),a.source!==b)return void h.warn("not the source - ignore");var e=d(a.data,h);if(h.log("data:",e),"dispatcher-ready"===e.mode&&(k?h.debug("dispatcher ready already"):(h.debug("dispatcher is ready now."),k=!0)),h.log("data message type: ",e.messageType),e.messageType)if(j.allMessageTypes&&!j[e.messageType])h.log("using the * handler for",e.messageType),j.allMessageTypes(e.messageType,e.data,c);else if(j[e.messageType])for(var f=0;f<j[e.messageType].length;f++)h.log("call the handler for",e.messageType),j[e.messageType][f](e.data,c)};h.log("add [handlePostMessage] to ",a.location.pathname),i.add(l.bind(this)),this.on=function(a,b){"*"===a?j.allMessageTypes=b:(j[a]=j[a]||[],j[a].push(b),h.log(".on - add handler for",a,"no of handlers:",j[a].length))},this.remove=function(){i.remove()},function(){function a(){h.log("sendReceiverReady",k),k||(h.log("sending receiver-ready"),b.postMessage(JSON.stringify({mode:"receiver-ready"}),"*"),setTimeout(a,300))}a()}()}function j(a,b,c){var d=new h(a,b,c),f=new i(a,b,c);this.send=function(){d.send.apply(d,e(arguments,0))},this.on=function(){f.on.apply(f,e(arguments,0))},this.remove=function(){d.remove(),f.remove()}}if(!JSON)throw"JSON is undefined, if you are using ie8 be sure to define a doctype eg: <!DOCTYPE html>";Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=e(arguments,1),c=this,d=function(){},f=function(){return c.apply(this instanceof d&&a?this:a,b.concat(e(arguments)))};return d.prototype=this.prototype,f.prototype=new d,f}),a.msgr=a.msgr||{},a.msgr.Receiver=i,a.msgr.Dispatcher=h,a.msgr.Channel=j,a.msgr.MessageListener=g,a.msgr.utils={getUid:b}}(this);